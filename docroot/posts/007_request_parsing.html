<html>
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" media="screen" href="../style/global.css" />
		<title>cozis</title>
		<!-- Matomo -->
		<script>
			var _paq = window._paq = window._paq || [];
			/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
			_paq.push(['trackPageView']);
			_paq.push(['enableLinkTracking']);
			(function() {
				var u="//coz.is:8443/";
				_paq.push(['setTrackerUrl', u+'matomo.php']);
				_paq.push(['setSiteId', '1']);
				var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
				g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
			})();
		</script>
		<!-- End Matomo Code -->
	</head>
	<body>
		<main>
			<header>
				<center>
					<span id="cozis-text">Cozis</span>
					<br />
					<nav>
						<a href="../index.html">index</a>
						•
						<a href="../projects.html">projects</a>
						•
						<a href="https://github.com/cozis" target="_blank">github</a>
						•
						<a href="https://www.linkedin.com/in/cozis/" target="_blank">linkedin</a>
					</nav>
				</center>
			</header>

			<article>
				<h1>Building web apps from scratch - Request Parsing - Part 2</h1>
<p>
<strong>NOTE: This post is still a work in progress!!</strong>

Our little web server is very cool, isn't it? The missing thing now, from a feature stand point, is sending a response based on what the client requested. But first, we need to improve its robustness a bit. There are some error corner cases that we haven't handled yet.

</p>
<h3>Handling partial sends</h3>
<p>
The first issue is relative to recv and send. We assumed that when we pass a buffer to send, the system will send the entire message or fail. This isn't correct. This function can also do partial sends. Lets say we want to send 100 bytes. The first time we send only 10 bytes may be sent, so we need to call send again with the remaining bytes
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">send_all</span>(<span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">sock</span>, <span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-operator">*</span><span class="c2h-identifier">src</span>, <span class="c2h-identifier">size_t</span> <span class="c2h-identifier">num</span>)</td></tr>
      <tr><td>2</td><td>{</td></tr>
      <tr><td>3</td><td>  <span class="c2h-identifier">size_t</span> <span class="c2h-identifier">sent</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>4</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">sent</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">num</span>) {</td></tr>
      <tr><td>5</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">just_sent</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">send</span>(<span class="c2h-identifier">sock</span>, (<span class="c2h-kword c2h-kword-char">char</span><span class="c2h-operator">*</span>) <span class="c2h-identifier">src</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">sent</span>, <span class="c2h-identifier">num</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">sent</span>, <span class="c2h-val-int">0</span>);</td></tr>
      <tr><td>6</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">just_sent</span> <span class="c2h-operator">&lt;</span> <span class="c2h-val-int">0</span>) <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>7</td><td>    <span class="c2h-identifier">sent</span> <span class="c2h-operator">+=</span> (<span class="c2h-identifier">size_t</span>) <span class="c2h-identifier">just_sent</span>;</td></tr>
      <tr><td>8</td><td>  }</td></tr>
      <tr><td>9</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">sent</span>;</td></tr>
      <tr><td>10</td><td>}</td></tr>
      <tr><td>11</td><td></td></tr>
    </table>
  </div>
</div>
<p>

This function calls <code>send</code> multiple times until every byte has been sent. If an error occurs before sending all bytes, it returns early with -1. By using this function in place of <code>send</code> we made our server much more reliable!

The <code>recv</code> function behaves in a similar way. Instead of worrying about sending only part of the bytes we need to worry about not receiving exactly how many bytes we had in our buffer. But since we are ignoring the incoming message for now, it does not make a difference.

</p>
<h3>The syntax of an HTTP request</h3>
<p>
Now we are ready to parse the client's request. This will allow us to return different responses based on what the client sent us.

The proper way to go about this would be reading the <a href="https://datatracker.ietf.org/doc/html/rfc2616">HTTP specification</a> and implement the parser accordingly, but starting with an approximation is good enough for now.

Here's an example of HTTP request:
</p>
<pre><code class="language-">GET / HTTP/1.1
Host: 127.0.0.1:8080
Connection: keep-alive
sec-ch-ua: &quot;Not(A:Brand&quot;;v=&quot;99&quot;, &quot;Brave&quot;;v=&quot;133&quot;, &quot;Chromium&quot;;v=&quot;133&quot;
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8
Sec-GPC: 1
Accept-Language: en-US,en;q=0.6
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br, zstd
</code></pre>
<p>

I obtained this by simply adding a print statement in our server after <code>recv</code> (don't forget the null terminator!).

The first line contains three things:</p>

<ol>
<li>method</li>
<li>resource path</li>
<li>HTTP version</li>
</ol>
<p>The method changes how the request is handled. The most common methods are</p>

<ol>
<li>GET: The client is asking us for a resource</li>
<li>POST: The client is sending us some data</li>
</ol>
<p>this is a bit simplistic, but we can focus on this later.

You can think of a resource path as the file name the client is requesting. Though the resource may be something other than a file, for instance we could have a resource called <code>/users</code> which returns a list of users returned by the database.

The version we'll support for now is <code>HTTP/1.0</code>, but this does not matter as version 1 and 1.1 use the same syntax.

The first line terminates with a new line, which is made with a carriage return and newline character. In C, these characters are written as <code>\r\n</code>. After that, we have a list of headers, strings in the form:
</p>
<pre><code class="language-">name: value\r\n
</code></pre>
<p>

we can mostly ignore these and only add support for specific ones as we need them. The one we are interested in is the <code>Content-Length</code> header, which tells us the length in bytes of the request payload. <code>GET</code> requests don't have a payload, so this header is not used. We will need it for <code>POST</code> requests.

After the entire header list, we find a <code>\r\n</code> character, not considering the <code>\r\n</code> used to close the last header. If the request had a payload, this is where it would start.

Just, to give you an example, this is how a <code>POST</code> request would look like:
</p>
<pre><code class="language-">POST /some-resource HTTP/1.0\r\n
host: 127.0.0.1\r\n
Content-Length: 15\r\n
\r\n
I'm the payload
</code></pre>
<p>

</p>
<h3>Parsing a request</h3>
<p>
Now we start writing the parser. There are many ways one can go about parsing, This is the way I found is easier for HTTP. The basic idea is we have a pointer to the request bytes, a length, and a cursor. We read the bytes by advancing the cursor and extract information from it by adding it to a structure. When the cursor reaches the end, we have a structure with all the information from the request bytes, easily accessible for our server. The request structure looks like this:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> { <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-operator">*</span><span class="c2h-identifier">data</span>; <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">size</span>; } <span class="c2h-identifier">string</span>;</td></tr>
      <tr><td>2</td><td></td></tr>
      <tr><td>3</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">MAX_HEADERS</span> <span class="c2h-val-int">32</span></td></tr>
      <tr><td>4</td><td></td></tr>
      <tr><td>5</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-enum">enum</span> {</td></tr>
      <tr><td>6</td><td>  <span class="c2h-identifier">HTTP_METHOD_GET</span>,</td></tr>
      <tr><td>7</td><td>  <span class="c2h-identifier">HTTP_METHOD_POST</span>,</td></tr>
      <tr><td>8</td><td>} <span class="c2h-identifier">HTTPMethod</span>;</td></tr>
      <tr><td>9</td><td></td></tr>
      <tr><td>10</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>11</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">name</span>;</td></tr>
      <tr><td>12</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">value</span>;</td></tr>
      <tr><td>13</td><td>} <span class="c2h-identifier">HTTPHeader</span>;</td></tr>
      <tr><td>14</td><td></td></tr>
      <tr><td>15</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>16</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">major</span>;</td></tr>
      <tr><td>17</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">minor</span>;</td></tr>
      <tr><td>18</td><td>} <span class="c2h-identifier">HTTPVersion</span>;</td></tr>
      <tr><td>19</td><td></td></tr>
      <tr><td>20</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>21</td><td>  <span class="c2h-identifier">HTTPMethod</span> <span class="c2h-identifier">method</span>;</td></tr>
      <tr><td>22</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">resource_path</span>;</td></tr>
      <tr><td>23</td><td>  <span class="c2h-identifier">HTTPVersion</span> <span class="c2h-identifier">version</span>;</td></tr>
      <tr><td>24</td><td>  <span class="c2h-identifier">HTTPHeader</span> <span class="c2h-identifier">headers</span>[<span class="c2h-identifier">MAX_HEADERS</span>];</td></tr>
      <tr><td>25</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">num_headers</span>;</td></tr>
      <tr><td>26</td><td>} <span class="c2h-identifier">HTTPRequest</span>;</td></tr>
      <tr><td>27</td><td></td></tr>
    </table>
  </div>
</div>
<p>

Notice how we created a helper structure for strings. This will come in handy for the entire project!

The parsing function will use this interface:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-identifier">bool</span> <span class="c2h-identifier c2h-fdeclname">parse_request</span>(<span class="c2h-identifier">string</span> <span class="c2h-identifier">src</span>, <span class="c2h-identifier">HTTPRequest</span> <span class="c2h-operator">*</span><span class="c2h-identifier">dst</span>)</td></tr>
      <tr><td>2</td><td>{</td></tr>
      <tr><td>3</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>4</td><td></td></tr>
      <tr><td>5</td><td>  <span class="c2h-comment">// .. parsing code goes here ..</span></td></tr>
      <tr><td>6</td><td>}</td></tr>
      <tr><td>7</td><td></td></tr>
    </table>
  </div>
</div>
<p>

if we parsed the request successfully, true is returned. If some error occurred, then false is returned. When the we succede, the <code>dst</code> argument will be initialized.

First, we parse the method. If the request doesn't start with <code>GET</code> or <code>POST</code>, we consider it an error:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">3</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span></td></tr>
      <tr><td>2</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'G'</span></td></tr>
      <tr><td>3</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'E'</span></td></tr>
      <tr><td>4</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>5</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>) {</td></tr>
      <tr><td>6</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">method</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">HTTP_METHOD_GET</span>;</td></tr>
      <tr><td>7</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">4</span>;</td></tr>
      <tr><td>8</td><td>} <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span></td></tr>
      <tr><td>9</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'P'</span></td></tr>
      <tr><td>10</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'O'</span></td></tr>
      <tr><td>11</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'S'</span></td></tr>
      <tr><td>12</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>13</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>) {</td></tr>
      <tr><td>14</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">method</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">HTTP_METHOD_POST</span>;</td></tr>
      <tr><td>15</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>16</td><td>} <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>17</td><td>  <span class="c2h-comment">// Invalid method</span></td></tr>
      <tr><td>18</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>19</td><td>}</td></tr>
      <tr><td>20</td><td></td></tr>
    </table>
  </div>
</div>
<p>

After this block, the cursor will point to the character that comes after the the first space, so the first character of the request path. The path goes from the first space to the second space.
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-comment">// Check that there is at least one non-space character where the cursor points</span></td></tr>
      <tr><td>2</td><td><span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>)</td></tr>
      <tr><td>3</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// No path</span></td></tr>
      <tr><td>4</td><td></td></tr>
      <tr><td>5</td><td><span class="c2h-comment">// Save the offset of the path in the string</span></td></tr>
      <tr><td>6</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">path_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>7</td><td></td></tr>
      <tr><td>8</td><td><span class="c2h-comment">// The first character is not a space. Now loop until we find one</span></td></tr>
      <tr><td>9</td><td><span class="c2h-kword c2h-kword-do">do</span></td></tr>
      <tr><td>10</td><td>  <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>11</td><td><span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">' '</span>);</td></tr>
      <tr><td>12</td><td></td></tr>
      <tr><td>13</td><td><span class="c2h-comment">// There are two ways we exit the loop:</span></td></tr>
      <tr><td>14</td><td><span class="c2h-comment">//   1) The cursor reached the end of the string because no space</span></td></tr>
      <tr><td>15</td><td><span class="c2h-comment">//      was found (cur == src.size)</span></td></tr>
      <tr><td>16</td><td><span class="c2h-comment">//   2) We found a space (src.data[cur] == ' ')</span></td></tr>
      <tr><td>17</td><td><span class="c2h-comment">// Of course (1) is an error</span></td></tr>
      <tr><td>18</td><td></td></tr>
      <tr><td>19</td><td><span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>20</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>21</td><td></td></tr>
      <tr><td>22</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">path_length</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">path_offset</span>;</td></tr>
      <tr><td>23</td><td></td></tr>
      <tr><td>24</td><td><span class="c2h-comment">// Consume the space that comes after the path</span></td></tr>
      <tr><td>25</td><td><span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>26</td><td></td></tr>
      <tr><td>27</td><td><span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">resource_path</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">string</span>) { .<span class="c2h-identifier">data</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">path_offset</span>, <span class="c2h-identifier">path_length</span> };</td></tr>
      <tr><td>28</td><td></td></tr>
    </table>
  </div>
</div>
<p>

Instead creating a copy of the resource path to store it in the <code>HTTPRequest</code> structure, we created a string that pointed inside the input buffer. With this trick we avoided a dynamic allocation. The downside of this is that the contents of <code>HTTPRequest</code> now depend on the input buffer staying around.

Now we parse the version. We expect one of the following strings: <code>HTTP/1</code>, <code>HTTP/1.0</code>, <code>HTTP/1.1</code>, followed by <code>\r\n</code>
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-comment">// If we don't find the string "HTTP/", that's an error</span></td></tr>
      <tr><td>2</td><td> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>3</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'H'</span></td></tr>
      <tr><td>4</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>5</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>6</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'P'</span></td></tr>
      <tr><td>7</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'/'</span>)</td></tr>
      <tr><td>8</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>9</td><td><span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>10</td><td></td></tr>
      <tr><td>11</td><td><span class="c2h-comment">// Now we expect either "1\r\n", "1.0\r\n", or "1.1\r\n"</span></td></tr>
      <tr><td>12</td><td><span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>13</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>14</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'.'</span></td></tr>
      <tr><td>15</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>16</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>17</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>18</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>19</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">1</span>};</td></tr>
      <tr><td>20</td><td>} <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>21</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>22</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'.'</span></td></tr>
      <tr><td>23</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'0'</span></td></tr>
      <tr><td>24</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>25</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>26</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>27</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">0</span>};</td></tr>
      <tr><td>28</td><td>} <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">2</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>29</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>30</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>31</td><td>  <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>32</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">3</span>;</td></tr>
      <tr><td>33</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">0</span>};</td></tr>
      <tr><td>34</td><td>} <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>35</td><td>  <span class="c2h-comment">// Invalid version</span></td></tr>
      <tr><td>36</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>37</td><td>}</td></tr>
      <tr><td>38</td><td></td></tr>
    </table>
  </div>
</div>
<p>

And that was the first line. Now comes the easy part! Now the cursor points to the first character of the list of headers. We must consume headers until we find the final <code>\r\n</code> which denotes the end of the request head.
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-comment">// Initialize the header array</span></td></tr>
      <tr><td>2</td><td><span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>3</td><td></td></tr>
      <tr><td>4</td><td><span class="c2h-comment">// Loop until we find the final \r\n</span></td></tr>
      <tr><td>5</td><td><span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">1</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>6</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>7</td><td>  <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>8</td><td></td></tr>
      <tr><td>9</td><td>  <span class="c2h-comment">// The cursor now points to the first character of the header's name</span></td></tr>
      <tr><td>10</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">name_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>11</td><td></td></tr>
      <tr><td>12</td><td>  <span class="c2h-comment">// Consume characters until we get to the separator</span></td></tr>
      <tr><td>13</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">':'</span>)</td></tr>
      <tr><td>14</td><td>    <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>15</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>16</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Cursor reached the end of the string</span></td></tr>
      <tr><td>17</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">header_name</span> <span class="c2h-operator">=</span> { <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">name_offset</span>, <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">name_offset</span> };</td></tr>
      <tr><td>18</td><td>  <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>; <span class="c2h-comment">// Consume the ':'</span></td></tr>
      <tr><td>19</td><td></td></tr>
      <tr><td>20</td><td>  <span class="c2h-comment">// Now the cursor points to the first character of the header value</span></td></tr>
      <tr><td>21</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">value_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>22</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span>)</td></tr>
      <tr><td>23</td><td>    <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>24</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>25</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Didn't find a '\r'</span></td></tr>
      <tr><td>26</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">header_value</span> <span class="c2h-operator">=</span> { <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">value_offset</span>, <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">value_offset</span> };</td></tr>
      <tr><td>27</td><td></td></tr>
      <tr><td>28</td><td>  <span class="c2h-comment">// Now we expect \r\n to terminate the header</span></td></tr>
      <tr><td>29</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">1</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>30</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>31</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span>)</td></tr>
      <tr><td>32</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Didn't find \r\n</span></td></tr>
      <tr><td>33</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>34</td><td></td></tr>
      <tr><td>35</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">MAX_HEADERS</span>)</td></tr>
      <tr><td>36</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// We reached the end of the static array</span></td></tr>
      <tr><td>37</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">headers</span>[<span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span><span class="c2h-operator">++</span>] <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPHeader</span>) { <span class="c2h-identifier">header_name</span>, <span class="c2h-identifier">header_value</span> };</td></tr>
      <tr><td>38</td><td>}</td></tr>
      <tr><td>39</td><td></td></tr>
      <tr><td>40</td><td><span class="c2h-comment">// We exited the loop, so we know there is a final \r\n we must skip</span></td></tr>
      <tr><td>41</td><td><span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>42</td><td></td></tr>
      <tr><td>43</td><td><span class="c2h-comment">// Finished</span></td></tr>
      <tr><td>44</td><td><span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">true</span>;</td></tr>
      <tr><td>45</td><td></td></tr>
    </table>
  </div>
</div>
<p>

And there it is! The request parser! It may seem quite daunting, but it's the same trick repeated over and over.

Here is the server with the added parser:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-directive">#include</span> <span class="c2h-val-str">&lt;stdio.h&gt;</span> <span class="c2h-comment">// printf</span></td></tr>
      <tr><td>2</td><td><span class="c2h-directive">#include</span> <span class="c2h-val-str">&lt;stdbool.h&gt;</span> <span class="c2h-comment">// bool, true, false</span></td></tr>
      <tr><td>3</td><td></td></tr>
      <tr><td>4</td><td><span class="c2h-directive">#ifdef</span> <span class="c2h-identifier">_WIN32</span></td></tr>
      <tr><td>5</td><td><span class="c2h-directive">#include</span> <span class="c2h-val-str">&lt;winsock2.h&gt;</span></td></tr>
      <tr><td>6</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">SOCKET</span></td></tr>
      <tr><td>7</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">INVALID_SOCKET_VALUE</span> <span class="c2h-identifier">INVALID_SOCKET</span></td></tr>
      <tr><td>8</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">CLOSE_SOCKET</span> <span class="c2h-identifier">closesocket</span></td></tr>
      <tr><td>9</td><td><span class="c2h-directive">#else</span></td></tr>
      <tr><td>10</td><td><span class="c2h-directive">#include</span> <span class="c2h-val-str">&lt;unistd.h&gt;</span> <span class="c2h-comment">// close</span></td></tr>
      <tr><td>11</td><td><span class="c2h-directive">#include</span> <span class="c2h-val-str">&lt;arpa/inet.h&gt;</span> <span class="c2h-comment">// socket, htons, inet_addr, sockaddr_in, bind, listen, accept, recv, send</span></td></tr>
      <tr><td>12</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-kword c2h-kword-int">int</span></td></tr>
      <tr><td>13</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">INVALID_SOCKET_VALUE</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span></td></tr>
      <tr><td>14</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">CLOSE_SOCKET</span> <span class="c2h-identifier">close</span></td></tr>
      <tr><td>15</td><td><span class="c2h-directive">#endif</span></td></tr>
      <tr><td>16</td><td></td></tr>
      <tr><td>17</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> { <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-operator">*</span><span class="c2h-identifier">data</span>; <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">size</span>; } <span class="c2h-identifier">string</span>;</td></tr>
      <tr><td>18</td><td></td></tr>
      <tr><td>19</td><td><span class="c2h-directive">#define</span> <span class="c2h-identifier">MAX_HEADERS</span> <span class="c2h-val-int">32</span></td></tr>
      <tr><td>20</td><td></td></tr>
      <tr><td>21</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-enum">enum</span> {</td></tr>
      <tr><td>22</td><td>  <span class="c2h-identifier">HTTP_METHOD_GET</span>,</td></tr>
      <tr><td>23</td><td>  <span class="c2h-identifier">HTTP_METHOD_POST</span>,</td></tr>
      <tr><td>24</td><td>} <span class="c2h-identifier">HTTPMethod</span>;</td></tr>
      <tr><td>25</td><td></td></tr>
      <tr><td>26</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>27</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">name</span>;</td></tr>
      <tr><td>28</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">value</span>;</td></tr>
      <tr><td>29</td><td>} <span class="c2h-identifier">HTTPHeader</span>;</td></tr>
      <tr><td>30</td><td></td></tr>
      <tr><td>31</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>32</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">major</span>;</td></tr>
      <tr><td>33</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">minor</span>;</td></tr>
      <tr><td>34</td><td>} <span class="c2h-identifier">HTTPVersion</span>;</td></tr>
      <tr><td>35</td><td></td></tr>
      <tr><td>36</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>37</td><td>  <span class="c2h-identifier">HTTPMethod</span> <span class="c2h-identifier">method</span>;</td></tr>
      <tr><td>38</td><td>  <span class="c2h-identifier">string</span> <span class="c2h-identifier">resource_path</span>;</td></tr>
      <tr><td>39</td><td>  <span class="c2h-identifier">HTTPVersion</span> <span class="c2h-identifier">version</span>;</td></tr>
      <tr><td>40</td><td>  <span class="c2h-identifier">HTTPHeader</span> <span class="c2h-identifier">headers</span>[<span class="c2h-identifier">MAX_HEADERS</span>];</td></tr>
      <tr><td>41</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">num_headers</span>;</td></tr>
      <tr><td>42</td><td>} <span class="c2h-identifier">HTTPRequest</span>;</td></tr>
      <tr><td>43</td><td></td></tr>
      <tr><td>44</td><td><span class="c2h-identifier">bool</span> <span class="c2h-identifier c2h-fdeclname">parse_request</span>(<span class="c2h-identifier">string</span> <span class="c2h-identifier">src</span>, <span class="c2h-identifier">HTTPRequest</span> <span class="c2h-operator">*</span><span class="c2h-identifier">dst</span>)</td></tr>
      <tr><td>45</td><td>{</td></tr>
      <tr><td>46</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>47</td><td></td></tr>
      <tr><td>48</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">3</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span></td></tr>
      <tr><td>49</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'G'</span></td></tr>
      <tr><td>50</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'E'</span></td></tr>
      <tr><td>51</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>52</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>) {</td></tr>
      <tr><td>53</td><td>    <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">method</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">HTTP_METHOD_GET</span>;</td></tr>
      <tr><td>54</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">4</span>;</td></tr>
      <tr><td>55</td><td>  } <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span></td></tr>
      <tr><td>56</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'P'</span></td></tr>
      <tr><td>57</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'O'</span></td></tr>
      <tr><td>58</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'S'</span></td></tr>
      <tr><td>59</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>60</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>) {</td></tr>
      <tr><td>61</td><td>    <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">method</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">HTTP_METHOD_POST</span>;</td></tr>
      <tr><td>62</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>63</td><td>  } <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>64</td><td>    <span class="c2h-comment">// Invalid method</span></td></tr>
      <tr><td>65</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>66</td><td>  }</td></tr>
      <tr><td>67</td><td></td></tr>
      <tr><td>68</td><td>  <span class="c2h-comment">// Check that there is at least one non-space character where the cursor points</span></td></tr>
      <tr><td>69</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">' '</span>)</td></tr>
      <tr><td>70</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// No path</span></td></tr>
      <tr><td>71</td><td></td></tr>
      <tr><td>72</td><td>  <span class="c2h-comment">// Save the offset of the path in the string</span></td></tr>
      <tr><td>73</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">path_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>74</td><td></td></tr>
      <tr><td>75</td><td>  <span class="c2h-comment">// The first character is not a space. Now loop until we find one</span></td></tr>
      <tr><td>76</td><td>  <span class="c2h-kword c2h-kword-do">do</span></td></tr>
      <tr><td>77</td><td>    <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>78</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">' '</span>);</td></tr>
      <tr><td>79</td><td></td></tr>
      <tr><td>80</td><td>  <span class="c2h-comment">// There are two ways we exit the loop:</span></td></tr>
      <tr><td>81</td><td>  <span class="c2h-comment">//   1) The cursor reached the end of the string because no space</span></td></tr>
      <tr><td>82</td><td>  <span class="c2h-comment">//      was found (cur == src.size)</span></td></tr>
      <tr><td>83</td><td>  <span class="c2h-comment">//   2) We found a space (src.data[cur] == ' ')</span></td></tr>
      <tr><td>84</td><td>  <span class="c2h-comment">// Of course (1) is an error</span></td></tr>
      <tr><td>85</td><td></td></tr>
      <tr><td>86</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>87</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>88</td><td></td></tr>
      <tr><td>89</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">path_length</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">path_offset</span>;</td></tr>
      <tr><td>90</td><td></td></tr>
      <tr><td>91</td><td>  <span class="c2h-comment">// Consume the space that comes after the path</span></td></tr>
      <tr><td>92</td><td>  <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>93</td><td></td></tr>
      <tr><td>94</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">resource_path</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">string</span>) { .<span class="c2h-identifier">data</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">path_offset</span>, <span class="c2h-identifier">path_length</span> };</td></tr>
      <tr><td>95</td><td></td></tr>
      <tr><td>96</td><td>  <span class="c2h-comment">// If we don't find the string "HTTP/", that's an error</span></td></tr>
      <tr><td>97</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>98</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'H'</span></td></tr>
      <tr><td>99</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>100</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'T'</span></td></tr>
      <tr><td>101</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'P'</span></td></tr>
      <tr><td>102</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'/'</span>)</td></tr>
      <tr><td>103</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>104</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>105</td><td></td></tr>
      <tr><td>106</td><td>  <span class="c2h-comment">// Now we expect either "1\r\n", "1.0\r\n", or "1.1\r\n"</span></td></tr>
      <tr><td>107</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>108</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>109</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'.'</span></td></tr>
      <tr><td>110</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>111</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>112</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>113</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>114</td><td>    <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">1</span>};</td></tr>
      <tr><td>115</td><td>  } <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">4</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>116</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>117</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'.'</span></td></tr>
      <tr><td>118</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'0'</span></td></tr>
      <tr><td>119</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>120</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">4</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>121</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">5</span>;</td></tr>
      <tr><td>122</td><td>    <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">0</span>};</td></tr>
      <tr><td>123</td><td>  } <span class="c2h-kword c2h-kword-else">else</span> <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">2</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>124</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'1'</span></td></tr>
      <tr><td>125</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>126</td><td>    <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">==</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>127</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">3</span>;</td></tr>
      <tr><td>128</td><td>    <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">version</span> <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPVersion</span>) {<span class="c2h-val-int">1</span>, <span class="c2h-val-int">0</span>};</td></tr>
      <tr><td>129</td><td>  } <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>130</td><td>    <span class="c2h-comment">// Invalid version</span></td></tr>
      <tr><td>131</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>;</td></tr>
      <tr><td>132</td><td>  }</td></tr>
      <tr><td>133</td><td></td></tr>
      <tr><td>134</td><td>  <span class="c2h-comment">// Initialize the header array</span></td></tr>
      <tr><td>135</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>136</td><td></td></tr>
      <tr><td>137</td><td>  <span class="c2h-comment">// Loop until we find the final \r\n</span></td></tr>
      <tr><td>138</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">1</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>139</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>140</td><td>    <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span>) {</td></tr>
      <tr><td>141</td><td></td></tr>
      <tr><td>142</td><td>    <span class="c2h-comment">// The cursor now points to the first character of the header's name</span></td></tr>
      <tr><td>143</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">name_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>144</td><td></td></tr>
      <tr><td>145</td><td>    <span class="c2h-comment">// Consume characters until we get to the separator</span></td></tr>
      <tr><td>146</td><td>    <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">':'</span>)</td></tr>
      <tr><td>147</td><td>      <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>148</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>149</td><td>      <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Cursor reached the end of the string</span></td></tr>
      <tr><td>150</td><td>    <span class="c2h-identifier">string</span> <span class="c2h-identifier">header_name</span> <span class="c2h-operator">=</span> { <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">name_offset</span>, <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">name_offset</span> };</td></tr>
      <tr><td>151</td><td>    <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>; <span class="c2h-comment">// Consume the ':'</span></td></tr>
      <tr><td>152</td><td></td></tr>
      <tr><td>153</td><td>    <span class="c2h-comment">// Now the cursor points to the first character of the header value</span></td></tr>
      <tr><td>154</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">value_offset</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">cur</span>;</td></tr>
      <tr><td>155</td><td>    <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">&&</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span>)</td></tr>
      <tr><td>156</td><td>      <span class="c2h-identifier">cur</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>157</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">cur</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span>)</td></tr>
      <tr><td>158</td><td>      <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Didn't find a '\r'</span></td></tr>
      <tr><td>159</td><td>    <span class="c2h-identifier">string</span> <span class="c2h-identifier">header_value</span> <span class="c2h-operator">=</span> { <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">value_offset</span>, <span class="c2h-identifier">cur</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">value_offset</span> };</td></tr>
      <tr><td>160</td><td></td></tr>
      <tr><td>161</td><td>    <span class="c2h-comment">// Now we expect \r\n to terminate the header</span></td></tr>
      <tr><td>162</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">1</span> <span class="c2h-operator">&gt;=</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">size</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">cur</span></td></tr>
      <tr><td>163</td><td>      <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>164</td><td>      <span class="c2h-operator">||</span> <span class="c2h-identifier">src</span>.<span class="c2h-identifier">data</span>[<span class="c2h-identifier">cur</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span>)</td></tr>
      <tr><td>165</td><td>      <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// Didn't find \r\n</span></td></tr>
      <tr><td>166</td><td>    <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>167</td><td></td></tr>
      <tr><td>168</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">MAX_HEADERS</span>)</td></tr>
      <tr><td>169</td><td>      <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">false</span>; <span class="c2h-comment">// We reached the end of the static array</span></td></tr>
      <tr><td>170</td><td>  <span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">headers</span>[<span class="c2h-identifier">dst</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_headers</span><span class="c2h-operator">++</span>] <span class="c2h-operator">=</span> (<span class="c2h-identifier">HTTPHeader</span>) { <span class="c2h-identifier">header_name</span>, <span class="c2h-identifier">header_value</span> };</td></tr>
      <tr><td>171</td><td>  }</td></tr>
      <tr><td>172</td><td></td></tr>
      <tr><td>173</td><td>  <span class="c2h-comment">// We exited the loop, so we know there is a final \r\n we must skip</span></td></tr>
      <tr><td>174</td><td>  <span class="c2h-identifier">cur</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>175</td><td></td></tr>
      <tr><td>176</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">true</span>;</td></tr>
      <tr><td>177</td><td>}</td></tr>
      <tr><td>178</td><td></td></tr>
      <tr><td>179</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">send_all</span>(<span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">sock</span>, <span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-operator">*</span><span class="c2h-identifier">src</span>, <span class="c2h-identifier">size_t</span> <span class="c2h-identifier">num</span>)</td></tr>
      <tr><td>180</td><td>{</td></tr>
      <tr><td>181</td><td>  <span class="c2h-identifier">size_t</span> <span class="c2h-identifier">sent</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>182</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-identifier">sent</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">num</span>) {</td></tr>
      <tr><td>183</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">just_sent</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">send</span>(<span class="c2h-identifier">sock</span>, (<span class="c2h-kword c2h-kword-char">char</span><span class="c2h-operator">*</span>) <span class="c2h-identifier">src</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">sent</span>, <span class="c2h-identifier">num</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">sent</span>, <span class="c2h-val-int">0</span>);</td></tr>
      <tr><td>184</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">just_sent</span> <span class="c2h-operator">&lt;</span> <span class="c2h-val-int">0</span>) <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>185</td><td>    <span class="c2h-identifier">sent</span> <span class="c2h-operator">+=</span> (<span class="c2h-identifier">size_t</span>) <span class="c2h-identifier">just_sent</span>;</td></tr>
      <tr><td>186</td><td>  }</td></tr>
      <tr><td>187</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">sent</span>;</td></tr>
      <tr><td>188</td><td>}</td></tr>
      <tr><td>189</td><td></td></tr>
      <tr><td>190</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">main</span>()</td></tr>
      <tr><td>191</td><td>{</td></tr>
      <tr><td>192</td><td><span class="c2h-directive">#ifdef</span> <span class="c2h-identifier">_WIN32</span></td></tr>
      <tr><td>193</td><td>  <span class="c2h-identifier">WSADATA</span> <span class="c2h-identifier">wsaData</span>;</td></tr>
      <tr><td>194</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">err</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">WSAStartup</span>(<span class="c2h-identifier c2h-fcallname">MAKEWORD</span>(<span class="c2h-val-int">2</span>, <span class="c2h-val-int">2</span>), <span class="c2h-operator">&</span><span class="c2h-identifier">wsaData</span>);</td></tr>
      <tr><td>195</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">err</span> <span class="c2h-operator">!=</span> <span class="c2h-val-int">0</span>) {</td></tr>
      <tr><td>196</td><td>    <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"WSAStartup failed\n"</span>);</td></tr>
      <tr><td>197</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>198</td><td>  }</td></tr>
      <tr><td>199</td><td><span class="c2h-directive">#endif</span></td></tr>
      <tr><td>200</td><td></td></tr>
      <tr><td>201</td><td>  <span class="c2h-comment">// Create the listening socket</span></td></tr>
      <tr><td>202</td><td>  <span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">listen_socket</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">socket</span>(<span class="c2h-identifier">AF_INET</span>, <span class="c2h-identifier">SOCK_STREAM</span>, <span class="c2h-val-int">0</span>);</td></tr>
      <tr><td>203</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">listen_socket</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">INVALID_SOCKET_VALUE</span>) {</td></tr>
      <tr><td>204</td><td>    <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"socket failed\n"</span>);</td></tr>
      <tr><td>205</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>206</td><td>  }</td></tr>
      <tr><td>207</td><td></td></tr>
      <tr><td>208</td><td>  <span class="c2h-kword c2h-kword-struct">struct</span> <span class="c2h-identifier">sockaddr_in</span> <span class="c2h-identifier">bind_buffer</span>;</td></tr>
      <tr><td>209</td><td>  <span class="c2h-identifier">bind_buffer</span>.<span class="c2h-identifier">sin_family</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">AF_INET</span>;</td></tr>
      <tr><td>210</td><td>  <span class="c2h-identifier">bind_buffer</span>.<span class="c2h-identifier">sin_port</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">htons</span>(<span class="c2h-val-int">8080</span>);</td></tr>
      <tr><td>211</td><td>  <span class="c2h-identifier">bind_buffer</span>.<span class="c2h-identifier">sin_addr</span>.<span class="c2h-identifier">s_addr</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">inet_addr</span>(<span class="c2h-val-str">"127.0.0.1"</span>);</td></tr>
      <tr><td>212</td><td></td></tr>
      <tr><td>213</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier c2h-fcallname">bind</span>(<span class="c2h-identifier">listen_socket</span>, (<span class="c2h-kword c2h-kword-struct">struct</span> <span class="c2h-identifier">sockaddr</span><span class="c2h-operator">*</span>) <span class="c2h-operator">&</span><span class="c2h-identifier">bind_buffer</span>, <span class="c2h-kword c2h-kword-sizeof">sizeof</span>(<span class="c2h-identifier">bind_buffer</span>))) {</td></tr>
      <tr><td>214</td><td>    <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"bind failed\n"</span>);</td></tr>
      <tr><td>215</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>216</td><td>  }</td></tr>
      <tr><td>217</td><td></td></tr>
      <tr><td>218</td><td>  <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier c2h-fcallname">listen</span>(<span class="c2h-identifier">listen_socket</span>, <span class="c2h-val-int">32</span>)) {</td></tr>
      <tr><td>219</td><td>    <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"listen failed\n"</span>);</td></tr>
      <tr><td>220</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>221</td><td>  }</td></tr>
      <tr><td>222</td><td></td></tr>
      <tr><td>223</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">1</span>) {</td></tr>
      <tr><td>224</td><td>    <span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">client_socket</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">accept</span>(<span class="c2h-identifier">listen_socket</span>, <span class="c2h-identifier">NULL</span>, <span class="c2h-identifier">NULL</span>);</td></tr>
      <tr><td>225</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">client_socket</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">INVALID_SOCKET_VALUE</span>) {</td></tr>
      <tr><td>226</td><td>      <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"accept failed\n"</span>);</td></tr>
      <tr><td>227</td><td>      <span class="c2h-kword c2h-kword-continue">continue</span>;</td></tr>
      <tr><td>228</td><td>    }</td></tr>
      <tr><td>229</td><td></td></tr>
      <tr><td>230</td><td>    <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">request_buffer</span>[<span class="c2h-val-int">4096</span>];</td></tr>
      <tr><td>231</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">len</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">recv</span>(<span class="c2h-identifier">client_socket</span>, <span class="c2h-identifier">request_buffer</span>, <span class="c2h-kword c2h-kword-sizeof">sizeof</span>(<span class="c2h-identifier">request_buffer</span>), <span class="c2h-val-int">0</span>);</td></tr>
      <tr><td>232</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">len</span> <span class="c2h-operator">&lt;</span> <span class="c2h-val-int">0</span>) {</td></tr>
      <tr><td>233</td><td>      <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"recv failed\n"</span>);</td></tr>
      <tr><td>234</td><td>      <span class="c2h-identifier c2h-fcallname">CLOSE_SOCKET</span>(<span class="c2h-identifier">client_socket</span>);</td></tr>
      <tr><td>235</td><td>      <span class="c2h-kword c2h-kword-continue">continue</span>;</td></tr>
      <tr><td>236</td><td>    }</td></tr>
      <tr><td>237</td><td></td></tr>
      <tr><td>238</td><td>    <span class="c2h-identifier">HTTPRequest</span> <span class="c2h-identifier">parsed_request</span>;</td></tr>
      <tr><td>239</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-operator">!</span><span class="c2h-identifier c2h-fcallname">parse_request</span>((<span class="c2h-identifier">string</span>) {<span class="c2h-identifier">request_buffer</span>, <span class="c2h-identifier">len</span>}, <span class="c2h-operator">&</span><span class="c2h-identifier">parsed_request</span>)) {</td></tr>
      <tr><td>240</td><td>      <span class="c2h-comment">// Parsing failed</span></td></tr>
      <tr><td>241</td><td>      <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">response_buffer</span>[] <span class="c2h-operator">=</span></td></tr>
      <tr><td>242</td><td>        <span class="c2h-val-str">"HTTP/1.0 400 Bad Request\r\n"</span></td></tr>
      <tr><td>243</td><td>        <span class="c2h-val-str">"Content-Length: 0\r\n"</span></td></tr>
      <tr><td>244</td><td>        <span class="c2h-val-str">"\r\n"</span>;</td></tr>
      <tr><td>245</td><td>      <span class="c2h-identifier c2h-fcallname">send_all</span>(<span class="c2h-identifier">client_socket</span>, <span class="c2h-identifier">response_buffer</span>, <span class="c2h-kword c2h-kword-sizeof">sizeof</span>(<span class="c2h-identifier">response_buffer</span>));</td></tr>
      <tr><td>246</td><td></td></tr>
      <tr><td>247</td><td>    } <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>248</td><td>      <span class="c2h-comment">// Parsing succeded</span></td></tr>
      <tr><td>249</td><td>      <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">response_buffer</span>[] <span class="c2h-operator">=</span></td></tr>
      <tr><td>250</td><td>        <span class="c2h-val-str">"HTTP/1.0 200 OK\r\n"</span></td></tr>
      <tr><td>251</td><td>        <span class="c2h-val-str">"Content-Length: 13\r\n"</span></td></tr>
      <tr><td>252</td><td>        <span class="c2h-val-str">"Content-Type: text/plain\r\n"</span></td></tr>
      <tr><td>253</td><td>        <span class="c2h-val-str">"\r\n"</span></td></tr>
      <tr><td>254</td><td>        <span class="c2h-val-str">"Hello, world!"</span>;</td></tr>
      <tr><td>255</td><td>      <span class="c2h-identifier c2h-fcallname">send_all</span>(<span class="c2h-identifier">client_socket</span>, <span class="c2h-identifier">response_buffer</span>, <span class="c2h-kword c2h-kword-sizeof">sizeof</span>(<span class="c2h-identifier">response_buffer</span>));</td></tr>
      <tr><td>256</td><td>    }</td></tr>
      <tr><td>257</td><td>    <span class="c2h-identifier c2h-fcallname">CLOSE_SOCKET</span>(<span class="c2h-identifier">client_socket</span>);</td></tr>
      <tr><td>258</td><td>  }</td></tr>
      <tr><td>259</td><td>  <span class="c2h-comment">// This point will never be reached</span></td></tr>
      <tr><td>260</td><td>}</td></tr>
      <tr><td>261</td><td></td></tr>
    </table>
  </div>
</div>
<p>

</p>
<h3>Handle partial reads</h3>
<p>
As we did with send, we need to make sure our call to recv read the entire request head. It is possible we read only part of the request head, in which case we need to call the recv function again. We can stop when we find the <code>\r\n\r\n</code>, which signifies the end of the head and start of the body. If we fill up the buffer before we find such token, we consider that an error.
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">recv_request_head</span>(<span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">sock</span>, <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-operator">*</span><span class="c2h-identifier">dst</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">max</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-operator">*</span><span class="c2h-identifier">head_len</span>)</td></tr>
      <tr><td>2</td><td>{</td></tr>
      <tr><td>3</td><td>  <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">received</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>4</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">1</span>) {</td></tr>
      <tr><td>5</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">just_received</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">recv</span>(<span class="c2h-identifier">sock</span>, <span class="c2h-identifier">dst</span> <span class="c2h-operator">+</span> <span class="c2h-identifier">received</span>, <span class="c2h-identifier">max</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">received</span>, <span class="c2h-val-int">0</span>);</td></tr>
      <tr><td>6</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">just_received</span> <span class="c2h-operator">&lt;</span> <span class="c2h-val-int">0</span>) <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>7</td><td>    <span class="c2h-identifier">received</span> <span class="c2h-operator">+=</span> <span class="c2h-identifier">just_received</span>;</td></tr>
      <tr><td>8</td><td>    </td></tr>
      <tr><td>9</td><td>    <span class="c2h-comment">// Look for \r\n\r\n</span></td></tr>
      <tr><td>10</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>11</td><td>    <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">3</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">received</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">i</span></td></tr>
      <tr><td>12</td><td>      <span class="c2h-operator">&&</span> (<span class="c2h-identifier">dst</span>[<span class="c2h-identifier">i</span><span class="c2h-operator">+</span><span class="c2h-val-int">0</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>13</td><td>      <span class="c2h-operator">||</span> <span class="c2h-identifier">dst</span>[<span class="c2h-identifier">i</span><span class="c2h-operator">+</span><span class="c2h-val-int">1</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span></td></tr>
      <tr><td>14</td><td>      <span class="c2h-operator">||</span> <span class="c2h-identifier">dst</span>[<span class="c2h-identifier">i</span><span class="c2h-operator">+</span><span class="c2h-val-int">2</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\r'</span></td></tr>
      <tr><td>15</td><td>      <span class="c2h-operator">||</span> <span class="c2h-identifier">dst</span>[<span class="c2h-identifier">i</span><span class="c2h-operator">+</span><span class="c2h-val-int">3</span>] <span class="c2h-operator">!=</span> <span class="c2h-val-char">'\n'</span>))</td></tr>
      <tr><td>16</td><td>      <span class="c2h-identifier">i</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>17</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-val-int">3</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">received</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">i</span>) {</td></tr>
      <tr><td>18</td><td>      <span class="c2h-comment">// We found the \r\n\r\n and it is at position "i"</span></td></tr>
      <tr><td>19</td><td>      <span class="c2h-comment">// We consider the head to go from the first byte to the last \n</span></td></tr>
      <tr><td>20</td><td>      <span class="c2h-operator">*</span><span class="c2h-identifier">head_len</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">+</span> <span class="c2h-val-int">4</span>;</td></tr>
      <tr><td>21</td><td>      <span class="c2h-kword c2h-kword-break">break</span>;</td></tr>
      <tr><td>22</td><td>    }</td></tr>
      <tr><td>23</td><td>    <span class="c2h-comment">// We did not find the end of the head. If the buffer is now full that's an error</span></td></tr>
      <tr><td>24</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">received</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">max</span>)</td></tr>
      <tr><td>25</td><td>      <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>26</td><td>  }</td></tr>
      <tr><td>27</td><td>  <span class="c2h-comment">// If we are here we received the head. Note that we may have also read some bytes after the \r\n\r\n, which are part of the request body.</span></td></tr>
      <tr><td>28</td><td>  <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">received</span>;</td></tr>
      <tr><td>29</td><td>}</td></tr>
      <tr><td>30</td><td></td></tr>
    </table>
  </div>
</div>
<p>

With this, our main loop changes:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-comment">// ... parsing and everything else stays the same ...</span></td></tr>
      <tr><td>2</td><td></td></tr>
      <tr><td>3</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">main</span>()</td></tr>
      <tr><td>4</td><td>{</td></tr>
      <tr><td>5</td><td>  <span class="c2h-comment">// ... this code stays the same too ...</span></td></tr>
      <tr><td>6</td><td></td></tr>
      <tr><td>7</td><td>  <span class="c2h-kword c2h-kword-while">while</span> (<span class="c2h-val-int">1</span>) {</td></tr>
      <tr><td>8</td><td>    <span class="c2h-identifier">SOCKET_TYPE</span> <span class="c2h-identifier">client_socket</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">accept</span>(<span class="c2h-identifier">listen_socket</span>, <span class="c2h-identifier">NULL</span>, <span class="c2h-identifier">NULL</span>);</td></tr>
      <tr><td>9</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">client_socket</span> <span class="c2h-operator">==</span> <span class="c2h-identifier">INVALID_SOCKET_VALUE</span>) {</td></tr>
      <tr><td>10</td><td>      <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"accept failed\n"</span>);</td></tr>
      <tr><td>11</td><td>      <span class="c2h-kword c2h-kword-continue">continue</span>;</td></tr>
      <tr><td>12</td><td>    }</td></tr>
      <tr><td>13</td><td></td></tr>
      <tr><td>14</td><td>    <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">request_buffer</span>[<span class="c2h-val-int">4096</span>];</td></tr>
      <tr><td>15</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">received_total</span>, <span class="c2h-identifier">head_len</span>;</td></tr>
      <tr><td>16</td><td>    <span class="c2h-identifier">received_total</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">recv_request_head</span>(<span class="c2h-identifier">client_socket</span>, <span class="c2h-identifier">request_buffer</span>, <span class="c2h-kword c2h-kword-sizeof">sizeof</span>(<span class="c2h-identifier">request_buffer</span>), <span class="c2h-operator">&</span><span class="c2h-identifier">head_len</span>);</td></tr>
      <tr><td>17</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">received_total</span> <span class="c2h-operator">&lt;</span> <span class="c2h-val-int">0</span>) {</td></tr>
      <tr><td>18</td><td>      <span class="c2h-identifier c2h-fcallname">printf</span>(<span class="c2h-val-str">"recv_request_head failed\n"</span>);</td></tr>
      <tr><td>19</td><td>      <span class="c2h-identifier c2h-fcallname">CLOSE_SOCKET</span>(<span class="c2h-identifier">client_socket</span>);</td></tr>
      <tr><td>20</td><td>      <span class="c2h-kword c2h-kword-continue">continue</span>;</td></tr>
      <tr><td>21</td><td>    }</td></tr>
      <tr><td>22</td><td>    <span class="c2h-identifier">string</span> <span class="c2h-identifier">request_head</span> <span class="c2h-operator">=</span> {<span class="c2h-identifier">request_buffer</span>, <span class="c2h-identifier">head_len</span>};</td></tr>
      <tr><td>23</td><td></td></tr>
      <tr><td>24</td><td>    <span class="c2h-identifier">HTTPRequest</span> <span class="c2h-identifier">parsed_request</span>;</td></tr>
      <tr><td>25</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-operator">!</span><span class="c2h-identifier c2h-fcallname">parse_request</span>(<span class="c2h-identifier">request_head</span>, <span class="c2h-operator">&</span><span class="c2h-identifier">parsed_request</span>)) {</td></tr>
      <tr><td>26</td><td>      <span class="c2h-comment">// ... unchanged ...</span></td></tr>
      <tr><td>27</td><td>    } <span class="c2h-kword c2h-kword-else">else</span> {</td></tr>
      <tr><td>28</td><td>      <span class="c2h-comment">// ... unchanged ...</span></td></tr>
      <tr><td>29</td><td>    }</td></tr>
      <tr><td>30</td><td>    <span class="c2h-identifier c2h-fcallname">CLOSE_SOCKET</span>(<span class="c2h-identifier">client_socket</span>);</td></tr>
      <tr><td>31</td><td>  }</td></tr>
      <tr><td>32</td><td>  <span class="c2h-comment">// This point will never be reached</span></td></tr>
      <tr><td>33</td><td>}</td></tr>
      <tr><td>34</td><td></td></tr>
    </table>
  </div>
</div>
<p>

</p>
<h3>Further improvements</h3>
<p>This parser will work well most of the time, but there are a couple corner cases we haven't handled:</p>

<ul>
<li>We are blindly accepting characters while parsing the headers and path. These strings have specific syntaxes and allowed characters</li>
<li>There is something called a "folded header", which is a header spanning over multiple lines. We don't need to handle them, but recognize and reject them at least.</li>
</ul>

			</article>
		</main>
	</body>
</html>
