<html>
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" media="screen" href="../style/global.css" />
		<title>cozis</title>
		<!-- Matomo -->
		<script>
			var _paq = window._paq = window._paq || [];
			/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
			_paq.push(['trackPageView']);
			_paq.push(['enableLinkTracking']);
			(function() {
				var u="//coz.is:8443/";
				_paq.push(['setTrackerUrl', u+'matomo.php']);
				_paq.push(['setSiteId', '1']);
				var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
				g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
			})();
		</script>
		<!-- End Matomo Code -->
	</head>
	<body>
		<main>
			<header>
				<center>
					<span id="cozis-text">Cozis</span>
					<br />
					<nav>
						<a href="../index.html">index</a>
						•
						<a href="../projects.html">projects</a>
						•
						<a href="https://github.com/cozis" target="_blank">github</a>
						•
						<a href="https://www.linkedin.com/in/cozis/" target="_blank">linkedin</a>
					</nav>
				</center>
			</header>

			<article>
				<h1>Write Robust Code With Soft State</h1>
<p>
While programming, I've noticed that the variables I use to hold state often feel redundant, since some variable values can be inferred from others. I began thinking of this as "redundancy" and developed an intuition for distinguishing between my program's "core state" and "redundant state".

<br />
<br />

Over time, I developed an approach to handle this redundancy that allows for more robust programs. I thought I'd share my intuitions here.

</p>
<h2>Programs Have Redundant State</h2>
<p>
First of all, let me show what I mean by redundant state.

<br />
<br />

Consider this code:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">buffer</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>2</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">used</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>3</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">unused</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">100</span>;</td></tr>
      <tr><td>4</td><td></td></tr>
    </table>
  </div>
</div>
<p>

The two variables count how many used and unused bytes are in the buffer. The buffer size is fixed, so the sum of the variable is always 100. This means each variable can be inferred from the other. For this reason I would call these variables "redundant" as you only need one. I would define as "core state" that which can't be inferred from other state. The core state in this example is the buffer and one of the two variables.

<br />
<br />

Now consider this code:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> <span class="c2h-identifier">Node</span> <span class="c2h-identifier">Node</span>;</td></tr>
      <tr><td>2</td><td><span class="c2h-kword c2h-kword-struct">struct</span> <span class="c2h-identifier">Node</span> {</td></tr>
      <tr><td>3</td><td>    <span class="c2h-identifier">Node</span> <span class="c2h-operator">*</span><span class="c2h-identifier">next</span>;</td></tr>
      <tr><td>4</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">value</span>;</td></tr>
      <tr><td>5</td><td>};</td></tr>
      <tr><td>6</td><td></td></tr>
      <tr><td>7</td><td><span class="c2h-identifier">Node</span> <span class="c2h-operator">*</span><span class="c2h-identifier">list</span>;</td></tr>
      <tr><td>8</td><td><span class="c2h-kword c2h-kword-int">int</span>   <span class="c2h-identifier">count</span>;</td></tr>
      <tr><td>9</td><td></td></tr>
    </table>
  </div>
</div>
<p>

It has a plain old linked list and a counter for the number of nodes. Here, the counter variable is redundant as it can be calculated by iterating over the nodes of the list.

<br />
<br />

We could define redundant state as that which can be computed from the remaining state, which I'm calling core state.

</p>
<h2>The Function of Redundancy</h2>
<p>
I remember asking myself after realizing this: what would happen if I wrote programs with no redundant state at all?

<br />
<br />

I would expect very inefficient programs, but also very robust ones.

<br />
<br />

When you add redundant state to your codebase, you need to add logic to make sure it's always synchronized with the rest of the data. For instance, in the list scenario you need to increment and decrement the counter when the list is modified. Often we forget to add such logic, causing the system to break. If the derived state weren't there, this type of mistake would not be possible.

<br />
<br />

On the other hand, the reason we add redundancy is to avoid unnecessary computations. It's true that we can infer the number of nodes of a list by iterating over it, but a counter variable would avoid that entirely at the cost of incrementing and decrementing the counter when we modify the list. Of course there is the chance we forget to do that, but it's a good trade-off overall.

</p>
<h2>Hard &amp; Soft State</h2>
<p>
I introduced the concepts of "core state" versus "redundant state", but there is another characterization of state that comes in handy here: the difference between soft and hard state.

<br />
<br />

I would define hard state as the data necessary for the program to run, and soft state as that which is not necessary but improves performance. The prime example of soft state is caches, which are the unsung heroes of software architecture.

<br />
<br />

Going back to our initial discussion, both the core and derived state in our program are hard state. The redundant state is assumed to always be up to date with the core state. If not, the program is broken.

<br />
<br />

But there is no reason why the redundant state cannot be treated as soft state. It should be possible to design our program to use redundant state but not require it. This would allow us to use the redundancy when convenient, but then have the option to throw it away when hard to manage.

<br />
<br />

Let me show an example.

</p>
<h2>Example</h2>
<p>
We are implementing a small social network where users can post articles and comment on them.

</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">Username</span>[<span class="c2h-val-int">60</span>];</td></tr>
      <tr><td>2</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">Content</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>3</td><td></td></tr>
      <tr><td>4</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>5</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">id</span>;</td></tr>
      <tr><td>6</td><td>    <span class="c2h-identifier">Username</span> <span class="c2h-identifier">author</span>;</td></tr>
      <tr><td>7</td><td>    <span class="c2h-identifier">Content</span>  <span class="c2h-identifier">content</span>;</td></tr>
      <tr><td>8</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">upvotes</span>;</td></tr>
      <tr><td>9</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">downvotes</span>;</td></tr>
      <tr><td>10</td><td>} <span class="c2h-identifier">Comment</span>;</td></tr>
      <tr><td>11</td><td></td></tr>
      <tr><td>12</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>13</td><td>    <span class="c2h-identifier">Username</span> <span class="c2h-identifier">author</span>;</td></tr>
      <tr><td>14</td><td>    <span class="c2h-identifier">Content</span>  <span class="c2h-identifier">content</span>;</td></tr>
      <tr><td>15</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">num_comments</span>;</td></tr>
      <tr><td>16</td><td>    <span class="c2h-identifier">Comment</span>  <span class="c2h-identifier">comments</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>17</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">upvotes</span>;</td></tr>
      <tr><td>18</td><td>    <span class="c2h-kword c2h-kword-int">int</span>      <span class="c2h-identifier">downvotes</span>;</td></tr>
      <tr><td>19</td><td>} <span class="c2h-identifier">Post</span>;</td></tr>
      <tr><td>20</td><td></td></tr>
      <tr><td>21</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">next_comment_id</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>22</td><td><span class="c2h-identifier">Post</span> <span class="c2h-identifier">posts</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>23</td><td></td></tr>
      <tr><td>24</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>25</td><td>{</td></tr>
      <tr><td>26</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">upvotes</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>27</td><td>}</td></tr>
      <tr><td>28</td><td></td></tr>
      <tr><td>29</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>30</td><td>{</td></tr>
      <tr><td>31</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">downvotes</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>32</td><td>}</td></tr>
      <tr><td>33</td><td></td></tr>
      <tr><td>34</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">add_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-identifier">Username</span> <span class="c2h-identifier">author</span>, <span class="c2h-identifier">Content</span> <span class="c2h-identifier">content</span>)</td></tr>
      <tr><td>35</td><td>{</td></tr>
      <tr><td>36</td><td>    <span class="c2h-identifier">Comment</span> <span class="c2h-operator">*</span><span class="c2h-identifier">comment</span> <span class="c2h-operator">=</span> <span class="c2h-operator">&</span><span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span><span class="c2h-operator">++</span>];</td></tr>
      <tr><td>37</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">id</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">init_comment</span>(<span class="c2h-identifier">comment</span>, <span class="c2h-identifier">author</span>, <span class="c2h-identifier">content</span>);</td></tr>
      <tr><td>38</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">id</span>;</td></tr>
      <tr><td>39</td><td>}</td></tr>
      <tr><td>40</td><td></td></tr>
      <tr><td>41</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">remove_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>42</td><td>{</td></tr>
      <tr><td>43</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">comment_by_id</span>(<span class="c2h-identifier">post</span>, <span class="c2h-identifier">comment_id</span>);</td></tr>
      <tr><td>44</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>] <span class="c2h-operator">=</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-operator">--</span><span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span>];</td></tr>
      <tr><td>45</td><td>}</td></tr>
      <tr><td>46</td><td></td></tr>
      <tr><td>47</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>48</td><td>{</td></tr>
      <tr><td>49</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">comment_by_id</span>(<span class="c2h-identifier">post</span>, <span class="c2h-identifier">comment_id</span>);</td></tr>
      <tr><td>50</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">upvotes</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>51</td><td>}</td></tr>
      <tr><td>52</td><td></td></tr>
      <tr><td>53</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>54</td><td>{</td></tr>
      <tr><td>55</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-identifier c2h-fcallname">comment_by_id</span>(<span class="c2h-identifier">post</span>, <span class="c2h-identifier">comment_id</span>);</td></tr>
      <tr><td>56</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">downvotes</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>57</td><td>}</td></tr>
      <tr><td>58</td><td></td></tr>
    </table>
  </div>
</div>
<p>

We later decide that instead of showing posts in chronological order, we want to score them and order them by their scores. Let's say this is the score function we settle upon:
</p>
<pre><code class="language-">post_score = (post_upvotes - post_downvotes) + 4 * comment_count + 2 * sum { (comment_upvotes[i] - comment_downvotes[i]) over i }
</code></pre>
<p>

It involves a number of parameters, like upvotes, downvotes, comments.

</p>
<h2>Hard State Solution</h2>
<p>
The hard state solution would be to add the score variable to our state and make sure that whenever one of the parameters it depends on changes, the score changes accordingly:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">Username</span>[<span class="c2h-val-int">60</span>];</td></tr>
      <tr><td>2</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-char">char</span> <span class="c2h-identifier">Content</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>3</td><td></td></tr>
      <tr><td>4</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>5</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>6</td><td>} <span class="c2h-identifier">Comment</span>;</td></tr>
      <tr><td>7</td><td></td></tr>
      <tr><td>8</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>9</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>10</td><td></td></tr>
      <tr><td>11</td><td>    <span class="c2h-comment">// New field</span></td></tr>
      <tr><td>12</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">score</span>;</td></tr>
      <tr><td>13</td><td>} <span class="c2h-identifier">Post</span>;</td></tr>
      <tr><td>14</td><td></td></tr>
      <tr><td>15</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">next_comment_id</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>16</td><td><span class="c2h-identifier">Post</span> <span class="c2h-identifier">posts</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>17</td><td></td></tr>
      <tr><td>18</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>19</td><td>{</td></tr>
      <tr><td>20</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>21</td><td></td></tr>
      <tr><td>22</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>23</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span><span class="c2h-operator">++</span>;</td></tr>
      <tr><td>24</td><td>}</td></tr>
      <tr><td>25</td><td></td></tr>
      <tr><td>26</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>27</td><td>{</td></tr>
      <tr><td>28</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>29</td><td></td></tr>
      <tr><td>30</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>31</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span><span class="c2h-operator">--</span>;</td></tr>
      <tr><td>32</td><td>}</td></tr>
      <tr><td>33</td><td></td></tr>
      <tr><td>34</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">add_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-identifier">Username</span> <span class="c2h-identifier">author</span>, <span class="c2h-identifier">Content</span> <span class="c2h-identifier">content</span>)</td></tr>
      <tr><td>35</td><td>{</td></tr>
      <tr><td>36</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>37</td><td></td></tr>
      <tr><td>38</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>39</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">4</span>;</td></tr>
      <tr><td>40</td><td></td></tr>
      <tr><td>41</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">id</span>;</td></tr>
      <tr><td>42</td><td>}</td></tr>
      <tr><td>43</td><td></td></tr>
      <tr><td>44</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">remove_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>45</td><td>{</td></tr>
      <tr><td>46</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>47</td><td></td></tr>
      <tr><td>48</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>49</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">-=</span> <span class="c2h-val-int">4</span>;</td></tr>
      <tr><td>50</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">-=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">upvotes</span>;</td></tr>
      <tr><td>51</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">downvotes</span>;</td></tr>
      <tr><td>52</td><td>}</td></tr>
      <tr><td>53</td><td></td></tr>
      <tr><td>54</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>55</td><td>{</td></tr>
      <tr><td>56</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>57</td><td></td></tr>
      <tr><td>58</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>59</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>60</td><td>}</td></tr>
      <tr><td>61</td><td></td></tr>
      <tr><td>62</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>63</td><td>{</td></tr>
      <tr><td>64</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>65</td><td></td></tr>
      <tr><td>66</td><td>    <span class="c2h-comment">// Update score</span></td></tr>
      <tr><td>67</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span> <span class="c2h-operator">-=</span> <span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>68</td><td>}</td></tr>
      <tr><td>69</td><td></td></tr>
      <tr><td>70</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">get_score</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>71</td><td>{</td></tr>
      <tr><td>72</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">score</span>;</td></tr>
      <tr><td>73</td><td>}</td></tr>
      <tr><td>74</td><td></td></tr>
    </table>
  </div>
</div>
<p>

If we forget to update the score or do it incorrectly, our program is essentially broken. If this were not an example, it would be even worse given the score function is something that changes often. I don't know about you, but this is nightmare fuel to me!

</p>
<h2>Hard State But No Redundancy Solution</h2>
<p>
Now let's see what happens when we remove the redundant state entirely. Instead of keeping track of the score, we calculate it on the fly.

<br />
<br />

Our resultant program will be the same as the first version with no scoring, with the addition of this function:
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">get_score</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>2</td><td>{</td></tr>
      <tr><td>3</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">score</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">upvotes</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">downvotes</span> <span class="c2h-operator">+</span> <span class="c2h-val-int">4</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span>;</td></tr>
      <tr><td>4</td><td></td></tr>
      <tr><td>5</td><td>    <span class="c2h-kword c2h-kword-for">for</span> (<span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>; <span class="c2h-identifier">i</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span>; <span class="c2h-identifier">i</span><span class="c2h-operator">++</span>) {</td></tr>
      <tr><td>6</td><td>        <span class="c2h-identifier">score</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">upvotes</span>;</td></tr>
      <tr><td>7</td><td>        <span class="c2h-identifier">score</span> <span class="c2h-operator">-=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">downvotes</span>;</td></tr>
      <tr><td>8</td><td>    }</td></tr>
      <tr><td>9</td><td></td></tr>
      <tr><td>10</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">score</span>;</td></tr>
      <tr><td>11</td><td>}</td></tr>
      <tr><td>12</td><td></td></tr>
    </table>
  </div>
</div>
<p>

Now all computation related to the score is in one function.

</p>
<h2>Soft State Solution</h2>
<p>
Now let's see the soft state solution. This involves storing the score, but allowing the program to work without it.
</p>
<div class="c2h-code">
  <div class="c2h-code-inner">
    <table>
      <tr><td>1</td><td><span class="c2h-kword c2h-kword-typedef">typedef</span> <span class="c2h-kword c2h-kword-struct">struct</span> {</td></tr>
      <tr><td>2</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>3</td><td>    <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">cached_score_value</span>;</td></tr>
      <tr><td>4</td><td>} <span class="c2h-identifier">Post</span>;</td></tr>
      <tr><td>5</td><td></td></tr>
      <tr><td>6</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">next_comment_id</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>;</td></tr>
      <tr><td>7</td><td><span class="c2h-identifier">Post</span> <span class="c2h-identifier">posts</span>[<span class="c2h-val-int">100</span>];</td></tr>
      <tr><td>8</td><td></td></tr>
      <tr><td>9</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>10</td><td>{</td></tr>
      <tr><td>11</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>12</td><td></td></tr>
      <tr><td>13</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>14</td><td>}</td></tr>
      <tr><td>15</td><td></td></tr>
      <tr><td>16</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_post</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>17</td><td>{</td></tr>
      <tr><td>18</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>19</td><td></td></tr>
      <tr><td>20</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>21</td><td>}</td></tr>
      <tr><td>22</td><td></td></tr>
      <tr><td>23</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">add_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-identifier">Username</span> <span class="c2h-identifier">author</span>, <span class="c2h-identifier">Content</span> <span class="c2h-identifier">content</span>)</td></tr>
      <tr><td>24</td><td>{</td></tr>
      <tr><td>25</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>26</td><td></td></tr>
      <tr><td>27</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>28</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">id</span>;</td></tr>
      <tr><td>29</td><td>}</td></tr>
      <tr><td>30</td><td></td></tr>
      <tr><td>31</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">remove_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>32</td><td>{</td></tr>
      <tr><td>33</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>34</td><td></td></tr>
      <tr><td>35</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>36</td><td>}</td></tr>
      <tr><td>37</td><td></td></tr>
      <tr><td>38</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">upvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>39</td><td>{</td></tr>
      <tr><td>40</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>41</td><td></td></tr>
      <tr><td>42</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>43</td><td>}</td></tr>
      <tr><td>44</td><td></td></tr>
      <tr><td>45</td><td><span class="c2h-kword c2h-kword-void">void</span> <span class="c2h-identifier c2h-fdeclname">downvote_comment</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>, <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">comment_id</span>)</td></tr>
      <tr><td>46</td><td>{</td></tr>
      <tr><td>47</td><td>    <span class="c2h-comment">// ...</span></td></tr>
      <tr><td>48</td><td></td></tr>
      <tr><td>49</td><td>    <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>;</td></tr>
      <tr><td>50</td><td>}</td></tr>
      <tr><td>51</td><td></td></tr>
      <tr><td>52</td><td><span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier c2h-fdeclname">get_score</span>(<span class="c2h-identifier">Post</span> <span class="c2h-operator">*</span><span class="c2h-identifier">post</span>)</td></tr>
      <tr><td>53</td><td>{</td></tr>
      <tr><td>54</td><td>    <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">==</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>) {</td></tr>
      <tr><td>55</td><td></td></tr>
      <tr><td>56</td><td>        <span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">score</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">upvotes</span> <span class="c2h-operator">-</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">downvotes</span> <span class="c2h-operator">+</span> <span class="c2h-val-int">4</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span>;</td></tr>
      <tr><td>57</td><td></td></tr>
      <tr><td>58</td><td>        <span class="c2h-kword c2h-kword-for">for</span> (<span class="c2h-kword c2h-kword-int">int</span> <span class="c2h-identifier">i</span> <span class="c2h-operator">=</span> <span class="c2h-val-int">0</span>; <span class="c2h-identifier">i</span> <span class="c2h-operator">&lt;</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">num_comments</span>; <span class="c2h-identifier">i</span><span class="c2h-operator">++</span>) {</td></tr>
      <tr><td>59</td><td>            <span class="c2h-identifier">score</span> <span class="c2h-operator">+=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">upvotes</span>;</td></tr>
      <tr><td>60</td><td>            <span class="c2h-identifier">score</span> <span class="c2h-operator">-=</span> <span class="c2h-val-int">2</span> <span class="c2h-operator">*</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">comments</span>[<span class="c2h-identifier">i</span>].<span class="c2h-identifier">downvotes</span>;</td></tr>
      <tr><td>61</td><td>        }</td></tr>
      <tr><td>62</td><td></td></tr>
      <tr><td>63</td><td>        <span class="c2h-kword c2h-kword-if">if</span> (<span class="c2h-identifier">score</span> <span class="c2h-operator">==</span> <span class="c2h-operator">-</span><span class="c2h-val-int">1</span>)</td></tr>
      <tr><td>64</td><td>            <span class="c2h-identifier">score</span> <span class="c2h-operator">=</span> <span class="c2h-operator">-</span><span class="c2h-val-int">2</span>;</td></tr>
      <tr><td>65</td><td></td></tr>
      <tr><td>66</td><td>        <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span> <span class="c2h-operator">=</span> <span class="c2h-identifier">score</span>;</td></tr>
      <tr><td>67</td><td>    }</td></tr>
      <tr><td>68</td><td></td></tr>
      <tr><td>69</td><td>    <span class="c2h-kword c2h-kword-return">return</span> <span class="c2h-identifier">post</span><span class="c2h-operator">-&gt;</span><span class="c2h-identifier">cached_score_value</span>;</td></tr>
      <tr><td>70</td><td>}</td></tr>
      <tr><td>71</td><td></td></tr>
    </table>
  </div>
</div>
<p>

The <code>cached_score_value</code> variable holds the current score of the post or -1, which means the score is uncomputed.

<br />
<br />

Regardless of whether the score is computed or not, we can call <code>get_score</code> which will return the current score and cache it for next time.

<br />
<br />

All the places where the score would change just cancel the current score, causing it to be recomputed from scratch next time. This completely removes the cost of having to mirror the changes to the core state (the post and comments) to the redundant state (the score).

</p>
<h2>Hybrid Approach</h2>
<p>
The hard state method optimizes for performance by avoiding the cost of computing the score as much as possible. The soft state technique pays the cost of extra computation to reduce complexity.

<br />
<br />

But the nice thing about this strategy is that you don't have to choose between performance and robustness: you can have an hybrid approach!

<br />
<br />

If keeping the redundant state up to date is easy, you can do that. No need to invalidate it unnecessarily. On the other hand if the derived state would be tricky to update, just invalidate it.

<br />
<br />

In conclusion, the soft state approach offers you a way to opt out of complex operations at the cost of extra computation.</p>

			</article>
		</main>
	</body>
</html>
